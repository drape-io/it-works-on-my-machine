name: ðŸ¤– Automated Flaky Test PR

on:
  schedule:
    # Run every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch:
    # Allow manual triggering for testing

env:
  PR_BRANCH: automated-flaky-test-run
  PR_TITLE: "ðŸ¤– Automated flaky test run"

jobs:
  merge-existing-pr:
    name: ðŸ”„ Merge Previous PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Merge existing automated PR
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          # Debug environment and authentication
          echo "ðŸ” DEBUG: Environment info"
          echo "ðŸ” DEBUG: Current working directory: $(pwd)"
          echo "ðŸ” DEBUG: Git remote URL: $(git config --get remote.origin.url)"
          echo "ðŸ” DEBUG: GH_TOKEN is set: $([ -n "$GH_TOKEN" ] && echo "YES" || echo "NO")"
          echo "ðŸ” DEBUG: Testing GitHub CLI auth..."
          gh auth status || echo "âš ï¸ GitHub CLI auth check failed"
          
          # Find existing automated PR
          echo "ðŸ” DEBUG: Looking for existing automated PRs..."
          pr_number=$(gh pr list --label "automated" --json number --jq '.[0].number // empty')

          if [ -n "$pr_number" ]; then
            echo "ðŸ”„ Found existing automated PR #$pr_number"

            # Get PR branch name
            pr_branch=$(gh pr view $pr_number --json headRefName --jq '.headRefName')
            echo "ðŸ“ PR branch: $pr_branch"

            # Update PR branch with latest main to satisfy branch protection
            echo "ðŸ”„ Updating PR branch with latest main..."
            echo "ðŸ” DEBUG: About to checkout PR #$pr_number"
            gh pr checkout $pr_number
            echo "âœ… DEBUG: Successfully checked out PR branch"
            
            echo "ðŸ” DEBUG: About to fetch origin main"
            git fetch origin main
            echo "âœ… DEBUG: Successfully fetched origin main"
            
            echo "ðŸ” DEBUG: About to merge origin/main"
            git merge origin/main --no-edit || {
              echo "âŒ Failed to merge main into PR branch - may have conflicts"
              git merge --abort 2>/dev/null || true
              echo "âš ï¸ Skipping merge due to conflicts, will try again next cycle"
              exit 0
            }
            echo "âœ… DEBUG: Successfully merged origin/main"
            
            echo "ðŸ” DEBUG: About to push to origin $pr_branch"
            git push origin $pr_branch
            echo "âœ… DEBUG: Successfully pushed to origin $pr_branch"
            echo "âœ… Updated PR branch with latest main"

            # Check if PR is mergeable (all checks passed)
            echo "ðŸ” DEBUG: About to check PR merge status"
            pr_status=$(gh pr view $pr_number --json mergeStateStatus --jq '.mergeStateStatus')
            echo "ðŸ“Š DEBUG: PR merge status is: $pr_status"

            if [ "$pr_status" = "CLEAN" ] || [ "$pr_status" = "UNSTABLE" ]; then
              echo "âœ… PR #$pr_number is ready to merge"
              echo "ðŸ” DEBUG: About to merge PR #$pr_number"
              gh pr merge $pr_number --squash --delete-branch
              echo "ðŸŽ‰ DEBUG: Successfully merged PR #$pr_number"
              echo "ðŸŽ‰ Merged PR #$pr_number"
            else
              echo "â³ PR #$pr_number not ready to merge (status: $pr_status)"
              echo "ðŸ’¡ Branch updated - tests may be running, will check next cycle"
            fi
          else
            echo "ðŸ“ No existing automated PR found"
          fi

  create-flaky-pr:
    name: ðŸŽ² Create New Automated Flaky Test PR
    needs: merge-existing-pr
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: main
        token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

    - name: Configure Git
      run: |
        git config --global user.name "flaky-test-bot"
        git config --global user.email "flaky-test-bot@users.noreply.github.com"

    - name: Read current run count
      id: read_count
      run: |
        if [ -f runs.txt ]; then
          CURRENT_COUNT=$(cat runs.txt)
        else
          CURRENT_COUNT=0
        fi
        NEW_COUNT=$((CURRENT_COUNT + 1))
        echo "current=$CURRENT_COUNT" >> $GITHUB_OUTPUT
        echo "new=$NEW_COUNT" >> $GITHUB_OUTPUT
        echo "ðŸ“Š Current run count: $CURRENT_COUNT"
        echo "ðŸ“ˆ New run count: $NEW_COUNT"

    - name: Update runs.txt
      run: |
        echo "${{ steps.read_count.outputs.new }}" > runs.txt
        echo "ðŸ“ Updated runs.txt to: $(cat runs.txt)"

    - name: Create timestamp for PR
      id: timestamp
      run: |
        TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
        echo "ðŸ•’ Timestamp: $TIMESTAMP"


    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        commit-message: "ðŸ¤– Automated flaky test run #${{ steps.read_count.outputs.new }}"
        title: "${{ env.PR_TITLE }} #${{ steps.read_count.outputs.new }}"
        body: |
          ## ðŸ¤– Automated Flaky Test Demonstration

          **Run #${{ steps.read_count.outputs.new }}** - ${{ steps.timestamp.outputs.timestamp }}

          This automated PR demonstrates:

          ### ðŸŽ¯ Flaky Test Behavior
          - Tests have **70%, 80%, and 90%** pass rates
          - Simulates real-world test flakiness
          - Shows importance of retry strategies

          ### ðŸ”„ Auto-Retry Mechanism
          - CI will retry failed tests up to **10 attempts**
          - Each retry is tracked in GitHub Actions API
          - Uses `nick-fields/retry` action for proper logging

          ### ðŸ¤– Automation Features
          - **Hourly schedule**: Creates PR every hour
          - **Auto-merge**: Merges when tests pass and checks are clean
          - **Run tracking**: Updates `runs.txt` counter

          ### ðŸ“Š Expected Behavior
          1. âœ… Tests may pass on first try (~50% chance)
          2. ðŸ”„ Or retry 2-4 times before passing
          3. ðŸŽ‰ Auto-merge when all tests green
          4. ðŸ“ˆ Counter increments for next run

          ### ðŸ“ˆ Data Collection
          This PR is part of ongoing flaky test data collection to analyze:
          - Retry patterns over time
          - Success rates across languages
          - CI/CD resilience strategies

          ---
          *This is run #${{ steps.read_count.outputs.new }} of the automated flaky test demonstration.*
        labels: |
          automated
          flaky-test-demo
          data-collection
        branch: ${{ env.PR_BRANCH }}-${{ steps.read_count.outputs.new }}
        delete-branch: true
