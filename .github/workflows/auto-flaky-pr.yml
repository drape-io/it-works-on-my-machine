name: ğŸ¤– Automated Flaky Test PR

on:
  schedule:
    # Run every hour at minute 0
    - cron: '0 * * * *'
  workflow_dispatch:
    # Allow manual triggering for testing

env:
  PR_BRANCH: automated-flaky-test-run
  PR_TITLE: "ğŸ¤– Automated flaky test run"

jobs:
  merge-existing-pr:
    name: ğŸ”„ Merge Previous PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Merge existing automated PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Find existing automated PR with security checks
          pr_data=$(gh pr list --label "automated" --json number,author --jq '.[0] // empty')

          if [ -n "$pr_data" ] && [ "$pr_data" != "null" ]; then
            pr_number=$(echo "$pr_data" | jq -r '.number')
            pr_author=$(echo "$pr_data" | jq -r '.author.login')

            echo "ğŸ”„ Found existing automated PR #$pr_number by @$pr_author"

            # Security check: Only merge PRs created by github-actions bot or repo owner
            if [ "$pr_author" = "github-actions[bot]" ] || [ "$pr_author" = "${{ github.repository_owner }}" ]; then
              echo "âœ… PR author verified: $pr_author"

              # Check if PR is mergeable (all checks passed)
              pr_status=$(gh pr view $pr_number --json mergeStateStatus --jq '.mergeStateStatus')

              if [ "$pr_status" = "CLEAN" ] || [ "$pr_status" = "UNSTABLE" ]; then
                echo "âœ… PR #$pr_number is ready to merge"
                gh pr merge $pr_number --squash --delete-branch
                echo "ğŸ‰ Merged PR #$pr_number"
              else
                echo "â³ PR #$pr_number not ready to merge (status: $pr_status)"
              fi
            else
              echo "ğŸš¨ SECURITY: Refusing to merge PR from untrusted author: $pr_author"
              echo "Only github-actions[bot] and ${{ github.repository_owner }} are allowed"
            fi
          else
            echo "ğŸ“ No existing automated PR found"
          fi

  create-flaky-pr:
    name: ğŸ² Create New Automated Flaky Test PR
    needs: merge-existing-pr
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure Git
      run: |
        git config --global user.name "flaky-test-bot"
        git config --global user.email "flaky-test-bot@users.noreply.github.com"

    - name: Read current run count
      id: read_count
      run: |
        if [ -f runs.txt ]; then
          CURRENT_COUNT=$(cat runs.txt)
        else
          CURRENT_COUNT=0
        fi
        NEW_COUNT=$((CURRENT_COUNT + 1))
        echo "current=$CURRENT_COUNT" >> $GITHUB_OUTPUT
        echo "new=$NEW_COUNT" >> $GITHUB_OUTPUT
        echo "ğŸ“Š Current run count: $CURRENT_COUNT"
        echo "ğŸ“ˆ New run count: $NEW_COUNT"

    - name: Update runs.txt
      run: |
        echo "${{ steps.read_count.outputs.new }}" > runs.txt
        echo "ğŸ“ Updated runs.txt to: $(cat runs.txt)"

    - name: Create timestamp for PR
      id: timestamp
      run: |
        TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
        echo "ğŸ•’ Timestamp: $TIMESTAMP"

    - name: Delete existing branch if it exists
      run: |
        git push origin --delete ${{ env.PR_BRANCH }} 2>/dev/null || echo "Branch ${{ env.PR_BRANCH }} doesn't exist"

    - name: Create new branch and commit changes
      run: |
        git checkout -b ${{ env.PR_BRANCH }}
        git add runs.txt
        git commit -m "ğŸ¤– Automated flaky test run #${{ steps.read_count.outputs.new }}

        Run count updated from ${{ steps.read_count.outputs.current }} to ${{ steps.read_count.outputs.new }}
        Timestamp: ${{ steps.timestamp.outputs.timestamp }}

        This PR demonstrates:
        - Flaky test behavior (75%, 85%, 95% pass rates)
        - Auto-retry mechanisms in CI/CD
        - Automated PR creation and merging

        Tests will retry until they pass, then auto-merge! ğŸ¯"

    - name: Push branch
      run: |
        git push origin ${{ env.PR_BRANCH }}

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        commit-message: "ğŸ¤– Automated flaky test run #${{ steps.read_count.outputs.new }}"
        title: "${{ env.PR_TITLE }} #${{ steps.read_count.outputs.new }}"
        body: |
          ## ğŸ¤– Automated Flaky Test Demonstration

          **Run #${{ steps.read_count.outputs.new }}** - ${{ steps.timestamp.outputs.timestamp }}

          This automated PR demonstrates:

          ### ğŸ¯ Flaky Test Behavior
          - Tests have **70%, 80%, and 90%** pass rates
          - Simulates real-world test flakiness
          - Shows importance of retry strategies

          ### ğŸ”„ Auto-Retry Mechanism
          - CI will retry failed tests up to **10 attempts**
          - Each retry is tracked in GitHub Actions API
          - Uses `nick-fields/retry` action for proper logging

          ### ğŸ¤– Automation Features
          - **Hourly schedule**: Creates PR every hour
          - **Auto-merge**: Merges when tests pass and checks are clean
          - **Run tracking**: Updates `runs.txt` counter

          ### ğŸ“Š Expected Behavior
          1. âœ… Tests may pass on first try (~50% chance)
          2. ğŸ”„ Or retry 2-4 times before passing
          3. ğŸ‰ Auto-merge when all tests green
          4. ğŸ“ˆ Counter increments for next run

          ### ğŸ“ˆ Data Collection
          This PR is part of ongoing flaky test data collection to analyze:
          - Retry patterns over time
          - Success rates across languages
          - CI/CD resilience strategies

          ---
          *This is run #${{ steps.read_count.outputs.new }} of the automated flaky test demonstration.*
        labels: |
          automated
          flaky-test-demo
          data-collection
        branch: ${{ env.PR_BRANCH }}-${{ steps.read_count.outputs.new }}
