name: ðŸŽ¯ Flaky Test Suite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: ðŸŽ² Test ${{ matrix.language }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language: [python, go, typescript]
        include:
          - language: python
            setup_cmd: |
              curl -LsSf https://astral.sh/uv/install.sh | sh
              echo "$HOME/.cargo/bin" >> $GITHUB_PATH
              uv python install 3.12
            install_cmd: install-python
            test_cmd: test-python-coverage
            coverage_paths: |
              python/coverage.xml
              python/htmlcov/
          - language: go
            setup_cmd: |
              # Go is pre-installed on ubuntu-latest
              go version
            install_cmd: install-go
            test_cmd: test-go-coverage
            coverage_paths: |
              go/coverage.out
              go/coverage.html
          - language: typescript
            setup_cmd: |
              # Node.js is pre-installed, just verify
              node --version
              npm --version
            install_cmd: install-ts
            test_cmd: test-ts-coverage
            coverage_paths: |
              typescript/coverage/
              typescript/junit.xml
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up ${{ matrix.language }} environment
      run: ${{ matrix.setup_cmd }}
    
    - name: Install just
      uses: extractions/setup-just@v2
    
    - name: Install ${{ matrix.language }} dependencies
      run: just ${{ matrix.install_cmd }}
    
    - name: Run ${{ matrix.language }} tests with retries
      id: test_with_retries
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 15
        max_attempts: 10
        retry_wait_seconds: 5
        command: just ${{ matrix.test_cmd }}
        shell: bash
        on_retry_command: |
          echo "ðŸ”„ Retry attempt $GITHUB_RUN_ATTEMPT for ${{ matrix.language }} - flaky behavior expected!"
          echo "ðŸ“Š This demonstrates real-world test flakiness patterns"
    
    - name: Log test completion
      if: always()
      run: |
        echo "ðŸ“Š ${{ matrix.language }} test completed with outcome: ${{ steps.test_with_retries.outcome }}"
    
    - name: Upload ${{ matrix.language }} coverage
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ${{ matrix.language }}-coverage
        path: ${{ matrix.coverage_paths }}
        retention-days: 30

  summary:
    name: ðŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [test]
    if: always()
    steps:
    - name: Generate test summary  
      run: |
        echo "## ðŸŽ¯ Flaky Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Language | Result | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ Python | ${{ needs.test.result }} | See job logs for retry details |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ¹ Go | ${{ needs.test.result }} | See job logs for retry details |" >> $GITHUB_STEP_SUMMARY  
        echo "| ðŸ“˜ TypeScript | ${{ needs.test.result }} | See job logs for retry details |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ² About Flaky Tests" >> $GITHUB_STEP_SUMMARY
        echo "- **Pass rates**: 70%, 80%, 90% (designed to fail occasionally)" >> $GITHUB_STEP_SUMMARY
        echo "- **Retry strategy**: Up to 10 attempts with 5-second delays" >> $GITHUB_STEP_SUMMARY
        echo "- **Real-world simulation**: Demonstrates CI/CD resilience patterns" >> $GITHUB_STEP_SUMMARY
        echo "- **Expected behavior**: Most runs pass after 2-4 attempts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ˆ Success Probability" >> $GITHUB_STEP_SUMMARY
        echo "With 4 tests (1 @ 100%, 1 @ 90%, 1 @ 80%, 1 @ 70%):" >> $GITHUB_STEP_SUMMARY
        echo "- **1 attempt**: ~50% chance all pass" >> $GITHUB_STEP_SUMMARY
        echo "- **3 attempts**: ~88% chance all pass" >> $GITHUB_STEP_SUMMARY
        echo "- **10 attempts**: ~99.9% chance all pass" >> $GITHUB_STEP_SUMMARY
