name: ðŸ”„ Re-run Failed Jobs

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'ID of the run to re-run'
        required: true
        type: string

jobs:
  rerun:
    name: ðŸ”„ Re-run Failed Jobs
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Re-run the failed workflow
      env:
        GH_REPO: ${{ github.repository }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        RUN_ID="${{ github.event.inputs.run_id }}"

        echo "ðŸ”„ Re-running failed jobs for workflow run: $RUN_ID"
        echo "ðŸ”— Original run: https://github.com/${{ github.repository }}/actions/runs/$RUN_ID"

        # Create retry summary
        echo "## ðŸ”„ Re-running Failed Jobs" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Original Run | [$RUN_ID](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID) |" >> $GITHUB_STEP_SUMMARY
        echo "| Re-run Time | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ This re-runs the SAME workflow run" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Satisfies required status checks" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Maintains same run ID and history" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Only retries jobs that failed" >> $GITHUB_STEP_SUMMARY

        # Wait for the original run to complete/fail before re-running
        echo "â³ Waiting for original run to complete..."
        gh run watch $RUN_ID > /dev/null 2>&1 || true

        # Re-run only the failed jobs in the original workflow
        echo "ðŸš€ Re-running failed jobs..."
        gh run rerun $RUN_ID --failed

        echo "âœ… Re-run triggered successfully"
        echo "ðŸ”— Monitor the re-run at: https://github.com/${{ github.repository }}/actions/runs/$RUN_ID"